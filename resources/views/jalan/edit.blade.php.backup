<x-app-layout>
    <x-slot name="header">
        <h2 class="font-semibold text-xl text-gray-800 leading-tight">
            {{ __('Edit Route') }}
        </h2>
    </x-slot>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        #map {
            width: 100%;
            height: 600px;
            position: relative;
            z-index: 0;
        }
        .waypoint-label {
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: bold;
            border: none;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        .hotel-label {
            background: rgba(255, 255, 255, 0.95);
            color: #1e40af;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            border: 1px solid #3b82f6;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .drag-marker {
            cursor: move;
        }
    </style>

    <div class="py-12">
        <div class="max-w-7xl mx-auto sm:px-6 lg:px-8">
            <div class="grid grid-cols-2 gap-6">
                <!-- Form Column -->
                <div class="bg-white overflow-hidden shadow-sm sm:rounded-lg">
                    <div class="p-6">
                        <form method="POST" action="{{ route('jalan.update', $jalan) }}">
                            @csrf
                            @method('PUT')

                            <div class="mb-4">
                                <label class="block text-sm font-medium mb-2">Route Name</label>
                                <input type="text" name="NamaJalan" value="{{ old('NamaJalan', $jalan->NamaJalan) }}" required 
                                    class="w-full border rounded px-3 py-2">
                                @error('NamaJalan')
                                    <p class="text-red-500 text-xs mt-1">{{ $message }}</p>
                                @enderror
                            </div>

                            <div class="grid grid-cols-2 gap-4 mb-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2">Start Point</label>
                                    <select name="StartPointID" id="startPoint" required class="w-full border rounded px-3 py-2">
                                        <option value="">Select hotel...</option>
                                        @php
                                            $currentStart = $hotels->firstWhere('PointID', old('StartPointID', $jalan->StartPointID));
                                            $otherHotels = $hotels->where('PointID', '!=', old('StartPointID', $jalan->StartPointID));
                                        @endphp
                                        @if($currentStart)
                                            <option value="{{ $currentStart->PointID }}"
                                                data-lat="{{ $currentStart->Latitude }}" 
                                                data-lng="{{ $currentStart->Longitude }}" selected>
                                                ⭐ {{ $currentStart->NamaObjek }} (Current)
                                            </option>
                                            <option disabled>──────────</option>
                                        @endif
                                        @foreach($otherHotels as $hotel)
                                            <option value="{{ $hotel->PointID }}"
                                                data-lat="{{ $hotel->Latitude }}" 
                                                data-lng="{{ $hotel->Longitude }}">
                                                {{ $hotel->NamaObjek }}
                                            </option>
                                        @endforeach
                                    </select>
                                    @error('StartPointID')
                                        <p class="text-red-500 text-xs mt-1">{{ $message }}</p>
                                    @enderror
                                </div>

                                <div>
                                    <label class="block text-sm font-medium mb-2">End Point</label>
                                    <select name="EndPointID" id="endPoint" required class="w-full border rounded px-3 py-2">
                                        <option value="">Select hotel...</option>
                                        @php
                                            $currentEnd = $hotels->firstWhere('PointID', old('EndPointID', $jalan->EndPointID));
                                            $otherHotelsEnd = $hotels->where('PointID', '!=', old('EndPointID', $jalan->EndPointID));
                                        @endphp
                                        @if($currentEnd)
                                            <option value="{{ $currentEnd->PointID }}"
                                                data-lat="{{ $currentEnd->Latitude }}" 
                                                data-lng="{{ $currentEnd->Longitude }}" selected>
                                                ⭐ {{ $currentEnd->NamaObjek }} (Current)
                                            </option>
                                            <option disabled>──────────</option>
                                        @endif
                                        @foreach($otherHotelsEnd as $hotel)
                                            <option value="{{ $hotel->PointID }}"
                                                data-lat="{{ $hotel->Latitude }}" 
                                                data-lng="{{ $hotel->Longitude }}">
                                                {{ $hotel->NamaObjek }}
                                            </option>
                                        @endforeach
                                    </select>
                                    @error('EndPointID')
                                        <p class="text-red-500 text-xs mt-1">{{ $message }}</p>
                                    @enderror
                                </div>
                            </div>

                            <div class="mb-4">
                                <label class="block text-sm font-medium mb-2">Distance (KM)</label>
                                <input type="number" step="0.01" name="DistanceKM" id="distanceKM" value="{{ old('DistanceKM', $jalan->DistanceKM) }}" required 
                                    class="w-full border rounded px-3 py-2" readonly>
                                <p class="text-xs text-gray-500 mt-1">Auto-calculated from route</p>
                                @error('DistanceKM')
                                    <p class="text-red-500 text-xs mt-1">{{ $message }}</p>
                                @enderror
                            </div>

                            <div class="mb-4">
                                <label class="block text-sm font-medium mb-2">Route Coordinates</label>
                                <textarea name="KoordinatJSON" id="koordinatJSON" rows="3" required 
                                    class="w-full border rounded px-3 py-2 font-mono text-xs bg-gray-50" readonly>{{ old('KoordinatJSON', json_encode($jalan->KoordinatJSON)) }}</textarea>
                                <p class="text-xs text-gray-500 mt-1">Click on map to redraw route</p>
                                @error('KoordinatJSON')
                                    <p class="text-red-500 text-xs mt-1">{{ $message }}</p>
                                @enderror
                            </div>

                            <div class="mb-4 p-3 bg-blue-50 rounded border border-blue-200">
                                <p class="text-sm font-medium text-blue-800 mb-1">Editing Instructions:</p>
                                <ul class="text-xs text-blue-700 list-disc list-inside space-y-1">
                                    <li><strong>Click blue line</strong> to insert a waypoint at that position</li>
                                    <li><strong>Click waypoint</strong> to enable drag mode, then drag to adjust</li>
                                    <li><strong>Right-click waypoint</strong> to delete it (any point, including END)</li>
                                    <li><strong>Double-click dragging marker</strong> to finish adjustment</li>
                                    <li>Hotel names are shown directly on map for easy reference</li>
                                    <li>Click "Clear" to start over</li>
                                </ul>
                            </div>

                            <div class="flex justify-end gap-2">
                                <a href="{{ route('jalan.index') }}" class="bg-gray-200 px-4 py-2 rounded hover:bg-gray-300">Cancel</a>
                                <button type="button" onclick="clearRoute()" class="bg-yellow-500 text-white px-4 py-2 rounded hover:bg-yellow-600">Clear</button>
                                <button type="button" onclick="finishRoute()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">Finish Route</button>
                                <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Update Route</button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Map Column -->
                <div class="bg-white overflow-hidden shadow-sm sm:rounded-lg">
                    <div class="p-6">
                        <h3 class="text-lg font-semibold mb-4">Edit Route on Map</h3>
                        <div id="map" class="w-full h-[600px] rounded border"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(function() {
                let map, polyline, routePoints = [], hotelMarkers = {};
                let isDrawing = false;

                // Initialize map
                map = L.map('map').setView([-7.2575, 112.7521], 13);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '© OpenStreetMap'
                }).addTo(map);
                setTimeout(() => map.invalidateSize(), 100);

                // Add hotel markers with permanent labels
                const hotels = @json($hotels);
                hotels.forEach(hotel => {
                    if (hotel.Latitude && hotel.Longitude) {
                        const marker = L.marker([hotel.Latitude, hotel.Longitude])
                            .addTo(map);
                        
                        // Add permanent label for hotel name
                        marker.bindTooltip(hotel.NamaObjek, {
                            permanent: true,
                            direction: 'top',
                            className: 'hotel-label',
                            offset: [0, -35]
                        });
                        
                        marker.bindPopup(`<b>${hotel.NamaObjek}</b><br>Click to view details`);
                        hotelMarkers[hotel.PointID] = marker;
                    }
                });

                // Load existing route
                @if($jalan->KoordinatJSON)
                    try {
                        let existingCoords = {!! json_encode($jalan->KoordinatJSON) !!};
                        if (typeof existingCoords === 'string') {
                            existingCoords = JSON.parse(existingCoords);
                        }
                        if (Array.isArray(existingCoords) && existingCoords.length > 0) {
                            routePoints = existingCoords.map(coord => [coord[1], coord[0]]);
                            updatePolyline();
                            if (polyline) {
                                map.fitBounds(polyline.getBounds());
                            }
                        }
                    } catch(e) {
                        console.error('Failed to load route:', e);
                    }
                @endif

                // Handle start/end point selection
                document.getElementById('startPoint').addEventListener('change', function() {
                    const option = this.options[this.selectedIndex];
                    if (option.value) {
                        const lat = parseFloat(option.dataset.lat);
                        const lng = parseFloat(option.dataset.lng);
                        if (!isNaN(lat) && !isNaN(lng)) {
                            routePoints = [[lat, lng]];
                            isDrawing = true;
                            updatePolyline();
                            updateJSON();
                            map.setView([lat, lng], 14);
                        }
                    }
                });

                document.getElementById('endPoint').addEventListener('change', updateJSON);

                // Handle map clicks for waypoints
                map.on('click', function(e) {
                    if (!isDrawing && routePoints.length === 0) {
                        alert('Please select start point first');
                        return;
                    }

                    isDrawing = true;
                    const lat = e.latlng.lat;
                    const lng = e.latlng.lng;
                    routePoints.push([lat, lng]);
                    updatePolyline();
                    updateJSON();
                });

                function updatePolyline() {
                    if (polyline) {
                        map.removeLayer(polyline);
                    }

                    // Clear previous waypoint markers
                    map.eachLayer(function(layer) {
                        if (layer instanceof L.Marker && layer.options.draggable) {
                            map.removeLayer(layer);
                        }llow clicking on line to insert waypoint
                        polyline.on('click', function(e) {
                            const clickedPoint = [e.latlng.lat, e.latlng.lng];
                            
                            // Find closest segment to insert the point
                            let minDistance = Infinity;
                            let insertIndex = 1;
                            
                            for (let i = 0; i < routePoints.length - 1; i++) {
                                const distance = getDistanceToSegment(
                                    clickedPoint,
                                    routePoints[i],
                                    routePoints[i + 1]
                                );
                                if (distance < minDistance) {
                                    minDistance = distance;
                                    insertIndex = i + 1;
                                }
                            }
                            
                            // Insert the point
                            routePoints.splice(insertIndex, 0, clickedPoint);
                            updatePolyline();
                            updateJSON();
                        });

                        // A
                    });

                    if (routePoints.length > 0) {
                        polyline = L.polyline(routePoints, {
                            color: 'blue',
                            weight: 4,
                            opacity: 0.7
                        }).addTo(map);all points can be deleted, end becomes end-1)
                            marker.on('contextmenu', function(e) {
                                L.DomEvent.preventDefault(e);
                                if (routePoints.length <= 2) {
                                    alert('Cannot delete - route needs at least 2 points (start and end)');
                                    return;
                                }
                                if (confirm(`Delete ${label}?${isEnd ? ' (Point ' + (index-1) + ' will become the new END)' : ''}`)) {
                                    routePoints.splice(index, 1);
                                    updatePolyline();
                                    updateJSON();
                                }
                            });
                            
                            const popupText = isStart ? `<b>${label}</b><br>Right-click to delete<br>(Need min 2 points)` :
                                            isEnd ? `<b>${label}</b><br>Right-click to delete<br>Point ${index-1} becomes new END` :
                                            `<b>Point ${index}</b><br>Right-click to delete<br>Click to make draggable`;
                            marker.bindPopup(popupText);   draggable: false,
                                weight: 2
                            }).addTo(map);

                            // Add label
                            const label = isStart ? 'START' : (isEnd ? 'END' : `Point ${index}`);
                            marker.bindTooltip(label, {
                                permanent: true,
                                direction: 'top',
                                className: 'waypoint-label',
                                offset: [0, -10]
                            });

                            // Right-click to delete (except start/end)
                            if (!isStart && !isEnd) {
                                marker.on('contextmenu', function(e) {
                                    L.DomEvent.preventDefault(e);
                                    if (confirm(`Delete Point ${index}?`)) {
                                        routePoints.splice(index, 1);
                                        updatePolyline();
                                        updateJSON();
                                    }
                                });
                                marker.bindPopup(`<b>Point ${index}</b><br>Right-click to delete<br>Click to make draggable`);
                            } else {
                                marker.bindPopup(`<b>${label}</b><br>Cannot delete ${isStart ? 'start' : 'end'} point`);
                            }

                            // Click to enable dragging for adjustment
                            marker.on('click', function() {
                                if (!isStart && !isEnd) {
                                    enableMarkerDrag(marker, index);
                                }
                            });
                        });
                    }
                }

                function enableMarkerDrag(marker, index) {
                    // Create a new draggable marker at the same position
                    const point = routePoints[index];
                    
                    // Remove the old marker
                    map.removeLayer(marker);
                    
                    // Create draggable marker
                    const dragMarker = L.marker(point, {
                        draggable: true,
                        icon: L.divIcon({
                            className: 'drag-marker',
                            html: `<div style="background: orange; width: 16px; height: 16px; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 4px rgba(0,0,0,0.5);"></div>`,
                            iconSize: [16, 16],
                            iconAnchor: [8, 8]
                        })
                    }).addTo(map);

                    dragMarker.bindTooltip(`Dragging Point ${index}`, {
                        permanent: true,
                        direction: 'top'
                    });

                    dragMarker.on('dragend', function(e) {
                        const newPos = e.target.getLatLng();
                        routePoints[index] = [newPos.lat, newPos.lng];
                        updatePolyline();
                        updateJSON();
                    });

                    // Double-click to finish dragging
                 

                // Helper function to find distance from point to line segment
                function getDistanceToSegment(point, segmentStart, segmentEnd) {
                    const [px, py] = point;
                    const [x1, y1] = segmentStart;
                    const [x2, y2] = segmentEnd;
                    
                    const dx = x2 - x1;
                    const dy = y2 - y1;
                    const lengthSquared = dx * dx + dy * dy;
                    
                    if (lengthSquared === 0) {
                        return Math.sqrt((px - x1) ** 2 + (py - y1) ** 2);
                    }
                    
                    let t = ((px - x1) * dx + (py - y1) * dy) / lengthSquared;
                    t = Math.max(0, Math.min(1, t));
                    
                    const projX = x1 + t * dx;
                    const projY = y1 + t * dy;
                    
                    return Math.sqrt((px - projX) ** 2 + (py - projY) ** 2);
                }   dragMarker.on('dblclick', function() {
                        updatePolyline();
                    });
                }

                function updateJSON() {
                    const coordinates = routePoints.map(point => [point[1], point[0]]);
                    document.getElementById('koordinatJSON').value = JSON.stringify(coordinates);

                    if (routePoints.length > 1) {
                        let distance = 0;
                        for (let i = 1; i < routePoints.length; i++) {
                            distance += calculateDistance(
                                routePoints[i-1][0], routePoints[i-1][1],
                                routePoints[i][0], routePoints[i][1]
                            );
                        }
                        document.getElementById('distanceKM').value = distance.toFixed(2);
                    }
                }

                function calculateDistance(lat1, lon1, lat2, lon2) {
                    const R = 6371;
                    const dLat = (lat2 - lat1) * Math.PI / 180;
                    const dLon = (lon2 - lon1) * Math.PI / 180;
                    const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                              Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                              Math.sin(dLon/2) * Math.sin(dLon/2);
                    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                    return R * c;
                }

                function finishRoute() {
                    const endSelect = document.getElementById('endPoint');
                    const option = endSelect.options[endSelect.selectedIndex];
                    
                    if (!option.value) {
                        alert('Please select end point');
                        return;
                    }

                    const lat = parseFloat(option.dataset.lat);
                    const lng = parseFloat(option.dataset.lng);
                    
                    if (!isNaN(lat) && !isNaN(lng)) {
                        routePoints.push([lat, lng]);
                        updatePolyline();
                        updateJSON();
                        isDrawing = false;
                        alert('Route completed! You can now update the route.');
                    }
                }

                function clearRoute() {
                    routePoints = [];
                    isDrawing = false;
                    if (polyline) {
                        map.removeLayer(polyline);
                        polyline = null;
                    }
                    map.eachLayer(function(layer) {
                        if (layer instanceof L.CircleMarker) {
                            map.removeLayer(layer);
                        }
                    });
                    document.getElementById('koordinatJSON').value = '';
                    document.getElementById('distanceKM').value = '';
                }

                // Make functions global
                window.clearRoute = clearRoute;
                window.finishRoute = finishRoute;
            }, 100);
        });
    </script>
</x-app-layout>
